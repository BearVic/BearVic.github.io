<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hello World!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="--to make the world&apos;s beauty.">
<meta property="og:type" content="website">
<meta property="og:title" content="Hello World!">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hello World!">
<meta property="og:description" content="--to make the world&apos;s beauty.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hello World!">
<meta name="twitter:description" content="--to make the world&apos;s beauty.">
  
    <link rel="alternate" href="/atom.xml" title="Hello World!" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hello World!</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-keras实现性别预测" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/03/keras实现性别预测/" class="article-date">
  <time datetime="2017-01-03T10:12:27.000Z" itemprop="datePublished">2017-01-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/03/keras实现性别预测/">keras实现性别预测</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>keras是经过封装后的tensorflow框架，整体使用方便快捷很多。在寇亚飞大神的悉心教导下，我用keras框架实现了体检单上的性别预测。同样，这篇文章将代码分成数据读取、网络模型定义和数据预测三个部分。</p>
<h3 id="数据读取"><a href="#数据读取" class="headerlink" title="数据读取"></a>数据读取</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># 通过pandas工具读取csv数据文件</div><div class="line">data = pd.read_csv(&apos;train.csv&apos;).values</div><div class="line">x_train = data[:,3:]</div><div class="line">y1_train = data[:,1:2]</div><div class="line"># 这里同样需要是性别数据转成int类型</div><div class="line">for x in range(len(y1_train)):</div><div class="line">    if y1_train[x] == &apos;\xc4\xd0&apos;:</div><div class="line">        y1_train[x] = 1</div><div class="line">    else:</div><div class="line">        y1_train[x] = 0</div><div class="line">y1_train = y1_train.astype(&apos;int32&apos;)</div><div class="line"># 将性别数据再转成二分类类型</div><div class="line">y1_train = np_utils.to_categorical(y1_train,2)</div></pre></td></tr></table></figure>
<h3 id="网络模型定义"><a href="#网络模型定义" class="headerlink" title="网络模型定义"></a>网络模型定义</h3><p>简单地将网络定义层2个全连接层和1个输出层。优化方法采用Adam方法，这是一种优化后的SGD方法。激发函数使用tanh，将数值归并到-1和1之间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">model = Sequential()</div><div class="line"></div><div class="line">model.add(Dense(300,input_shape = (26,)))</div><div class="line">model.add(Activation(&apos;tanh&apos;))</div><div class="line"></div><div class="line">model.add(Dense(300))</div><div class="line">model.add(Activation(&apos;tanh&apos;))</div><div class="line"></div><div class="line">model.add(Dense(2))</div><div class="line">model.add(Activation(&apos;softmax&apos;))</div><div class="line">model.compile(loss=&apos;categorical_crossentropy&apos;,</div><div class="line">optimizer=Adam(),</div><div class="line">metrics=[&apos;accuracy&apos;])</div></pre></td></tr></table></figure>
<h3 id="训练、保存及预测"><a href="#训练、保存及预测" class="headerlink" title="训练、保存及预测"></a>训练、保存及预测</h3><p>将性别预测封装成函数，读取之前训练过的数据模型，对新的数据进行预测。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">    model.fit(x_train,y1_train,batch_size=100,nb_epoch=50,verbose =1,shuffle=True)</div><div class="line">    model.save(&apos;gender.h5&apos;)</div><div class="line"></div><div class="line">def predict_sex():</div><div class="line">    FILE_PATH1 = &apos;gender.h5&apos;</div><div class="line">    if os.path.exists(FILE_PATH1):</div><div class="line">        model1 = load_model(FILE_PATH1)</div><div class="line">    else:</div><div class="line">        train()</div><div class="line">        model1 = load_model(FILE_PATH1)</div><div class="line">        </div><div class="line">    result1 = model1.predict_classes(data,batch_size = 1,verbose =0)</div><div class="line">    return result1[0]</div></pre></td></tr></table></figure>
<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p>最终预测的结果能达到73%左右。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/03/keras实现性别预测/" data-id="cixhql1gk0004f6fy81bjim4z" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-tensorflow实现手写识别" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/02/tensorflow实现手写识别/" class="article-date">
  <time datetime="2017-01-02T12:29:27.000Z" itemprop="datePublished">2017-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/02/tensorflow实现手写识别/">tensorflow实现手写识别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>看过一段时间tensorflow的教程，看代码能知个大概，也算入了门。当时学的时候发现最蛋疼的就是如何调输入数据的格式了。自学能力差到一定的极致，就是看了几天教程这一个问题还是没得到解决。但是我还是对A1课程上的手写识别做了简单的训练预测。代表我入门过。（仅仅是入门，代码简单大神再见）  </p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>使用 TensorFlow, 你必须明白 TensorFlow:</p>
<ul>
<li>使用图 (graph) 来表示计算任务.</li>
<li>在被称之为 会话 (Session) 的上下文 (context) 中执行图.</li>
<li>使用 tensor 表示数据.</li>
<li>通过 变量 (Variable) 维护状态.</li>
<li>使用 feed 和 fetch 可以为任意的操作(arbitrary operation) 赋值或者从其中获取数据.  </li>
</ul>
<p>从我个人理解出发，tensorflow的框架使用也大致分为三个部分：网络结构定义，数据格式调整及输入，数据预测。python只是tensorflow的一个数据输入接口，实际做训练预测都是通过C语言来实现的，这是为了提高速度和效率。接下来就分这三个模块介绍下我的代码。  </p>
<h4 id="网络结构定义"><a href="#网络结构定义" class="headerlink" title="网络结构定义"></a>网络结构定义</h4><p>代码如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">x = tf.placeholder(tf.float32, [None, 400])  # 图像输入向量</div><div class="line">W = tf.Variable(tf.zeros([400, 10]))  # 权重，初始化值为全零</div><div class="line">b = tf.Variable(tf.zeros([10]))  # 偏置，初始化值为全零</div><div class="line"># 进行模型计算，y是预测，y_ 是实际</div><div class="line">y = tf.nn.softmax(tf.matmul(x, W) + b)</div><div class="line">y_ = tf.placeholder(&quot;float&quot;, [None, 10])</div><div class="line"># 计算交叉熵</div><div class="line">cross_entropy = -tf.reduce_sum(y_ * tf.log(y))</div><div class="line"># 接下来使用BP算法来进行微调,以0.01的学习速率</div><div class="line">train_step = tf.train.GradientDescentOptimizer(0.01).minimize(cross_entropy)</div><div class="line"># 上面设置好了模型，添加初始化创建变量的操作</div><div class="line">init = tf.initialize_all_variables()</div><div class="line"># 启动创建的模型，并初始化变量</div><div class="line">sess = tf.Session()</div><div class="line">sess.run(init)</div></pre></td></tr></table></figure>
<h4 id="数据格式调整及输入"><a href="#数据格式调整及输入" class="headerlink" title="数据格式调整及输入"></a>数据格式调整及输入</h4><p>代码如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># 从老师提供的csv数据文件中读取数据</div><div class="line">data_matrix = np.loadtxt(open(&apos;data.csv&apos;, &apos;rb&apos;), delimiter=&apos;,&apos;)</div><div class="line">data_labels = np.loadtxt(open(&apos;dataLabels.csv&apos;, &apos;rb&apos;))</div><div class="line">data_indice = range(5000)</div><div class="line">random.shuffle(data_indice)</div><div class="line">train_data = []</div><div class="line">test_data = []</div><div class="line">labels = []</div><div class="line">train_labels = []</div><div class="line">test_labels = []</div><div class="line"># 需要将数据转换成one hot向量形式</div><div class="line">for i in range(data_labels.size):</div><div class="line">    labels.append([0] * 10)</div><div class="line">    labels[i][int(data_labels[i])] = 1</div><div class="line">count = 0</div><div class="line">for i in data_indice:</div><div class="line">    if (count &lt; 4500):</div><div class="line">        train_data.append(data_matrix[i])</div><div class="line">        train_labels.append(labels[i])</div><div class="line">    else:</div><div class="line">        test_data.append(data_matrix[i])</div><div class="line">        test_labels.append(labels[i])</div><div class="line">    count += 1</div></pre></td></tr></table></figure>
<h4 id="数据预测"><a href="#数据预测" class="headerlink" title="数据预测"></a>数据预测</h4><p>代码如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">print (&quot;train beginning...&quot;)</div><div class="line">sess.run(train_step, feed_dict=&#123;x: train_data, y_: train_labels&#125;)</div><div class="line">&apos;&apos;&apos; 进行模型评估 &apos;&apos;&apos;</div><div class="line"># 判断预测标签和实际标签是否匹配</div><div class="line">correct_prediction = tf.equal(tf.argmax(y, 1), tf.argmax(y_, 1))</div><div class="line">accuracy = tf.reduce_mean(tf.cast(correct_prediction, &quot;float&quot;))</div><div class="line"># 计算所学习到的模型在测试数据集上面的正确率</div><div class="line">print(sess.run(accuracy, feed_dict=&#123;x: test_data, y_: test_labels&#125;))</div><div class="line">print (&quot;ok&quot;)</div></pre></td></tr></table></figure>
<h4 id="结果显示"><a href="#结果显示" class="headerlink" title="结果显示"></a>结果显示</h4><p><img src="/img/digits_predict_res.jpg" alt="简单网络手写识别结果"><br>因为使用了最简单的网络，重点在于入门，所以准确率很低，才61%，也无伤大雅吧（尴尬的笑）。</p>
<h2 id="心得体会"><a href="#心得体会" class="headerlink" title="心得体会"></a>心得体会</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/02/tensorflow实现手写识别/" data-id="cixhql1gs0007f6fy6q3rynlc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-caffe自定义网络模型实现图像识别" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/02/caffe自定义网络模型实现图像识别/" class="article-date">
  <time datetime="2017-01-02T12:28:40.000Z" itemprop="datePublished">2017-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/02/caffe自定义网络模型实现图像识别/">caffe自定义网络模型实现图像识别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>caffe是个很好用的机器学习工具，尤其是在图像处理做卷积神经网络方面。要掌握caffe，最主要的要掌握：</p>
<ul>
<li>数据生成</li>
<li>网络结构定义</li>
<li>solver配置文件参数设置</li>
</ul>
<p>接下来我逐一为大家介绍。</p>
<h2 id="生成LMDB数据"><a href="#生成LMDB数据" class="headerlink" title="生成LMDB数据"></a>生成LMDB数据</h2><h4 id="数据下载"><a href="#数据下载" class="headerlink" title="数据下载"></a>数据下载</h4><p>这次项目是实现500张5个类别.jpg图片的训练和测试识别。在这里为大家提供了数据源的链接：<a href="https://pan.baidu.com/s/1MotUe" target="_blank" rel="external">https://pan.baidu.com/s/1MotUe</a><br>这些数据共有500张图片，分为大巴车、恐龙、大象、鲜花和马五个类，每个类100张。编号分别以0,1,2,3,4开头，各为一类。</p>
<h4 id="生成图片清单文件"><a href="#生成图片清单文件" class="headerlink" title="生成图片清单文件"></a>生成图片清单文件</h4><p>创建一个sh脚本文件，调用linux命令生成图片清单(当然你喜欢的话，你也可以自己写)：<br><code>sudo vi examples/images/create_filelist.sh</code></p>
<p>在这个文件中输入如下代码并保存 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># /usr/bin/env sh</div><div class="line">DATA=/home/hero/caffe/examples/my_first/train</div><div class="line">echo &quot;Create train.txt...&quot;</div><div class="line">rm -rf $DATA/train.txt</div><div class="line">find $DATA -name &apos;*3??.jpg&apos; | cut -d &apos;/&apos; -f8 | sed &quot;s/$/ 1/&quot;&gt;&gt;$DATA/train.txt</div><div class="line">find $DATA -name &apos;*4??.jpg&apos; | cut -d &apos;/&apos; -f8 | sed &quot;s/$/ 2/&quot;&gt;&gt;$DATA/tmp1.txt</div><div class="line">find $DATA -name &apos;*5??.jpg&apos; | cut -d &apos;/&apos; -f8 | sed &quot;s/$/ 3/&quot;&gt;&gt;$DATA/tmp2.txt</div><div class="line">find $DATA -name &apos;*6??.jpg&apos; | cut -d &apos;/&apos; -f8 | sed &quot;s/$/ 4/&quot;&gt;&gt;$DATA/tmp3.txt</div><div class="line">find $DATA -name &apos;*7??.jpg&apos; | cut -d &apos;/&apos; -f8 | sed &quot;s/$/ 0/&quot;&gt;&gt;$DATA/tmp4.txt</div><div class="line">cat $DATA/tmp1.txt&gt;&gt;$DATA/train.txt</div><div class="line">rm -rf $DATA/tmp1.txt</div><div class="line">cat $DATA/tmp2.txt&gt;&gt;$DATA/train.txt</div><div class="line">rm -rf $DATA/tmp2.txt</div><div class="line">cat $DATA/tmp3.txt&gt;&gt;$DATA/train.txt</div><div class="line">rm -rf $DATA/tmp3.txt</div><div class="line">cat $DATA/tmp4.txt&gt;&gt;$DATA/train.txt</div><div class="line">rm -rf $DATA/tmp4.txt</div><div class="line">echo &quot;Done..&quot;</div></pre></td></tr></table></figure>
<p>运行</p>
<p><code>sudo sh examples/images/create_filelist.sh</code></p>
<p>类似的生成相应的测试图片清单（其中相关了命令不在此介绍，可自行百度）。<br>最终生成train.txt文件如下(test.txt类似)：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">370.jpg 1</div><div class="line">386.jpg 1</div><div class="line">398.jpg 1</div><div class="line">364.jpg 1</div><div class="line">389.jpg 1</div><div class="line">352.jpg 1</div><div class="line">...</div></pre></td></tr></table></figure>
<h4 id="生成lmdb数据文件"><a href="#生成lmdb数据文件" class="headerlink" title="生成lmdb数据文件"></a>生成lmdb数据文件</h4><p>由于参数较多，我们还是创建sh脚本文件运行(这样也比较酷):<br><code>sudo vi examples/images/create_lmdb.sh</code></p>
<p>编辑并保存:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/en sh</div><div class="line">DATA=/home/hero/caffe/examples/my_first/train</div><div class="line">rm -rf $DATA/img_train_lmdb</div><div class="line">rm -rf $DATA/img_test_lmdb</div><div class="line">/home/hero/caffe/build/tools/convert_imageset --shuffle=true \</div><div class="line">--resize_height=38 --resize_width=38 \</div><div class="line">/home/hero/caffe/examples/my_first/train/ $DATA/train.txt  $DATA/img_train_lmdb</div></pre></td></tr></table></figure>
<p>其中设置参数shuffle打乱图片顺序，为了快速学习，将图片大小resize成38*38（硬件受限，这样程序跑的快一点）。然后输入<br><code>sudo sh examples/images/create_lmdb.sh</code><br>运行程序，生成所要的数据文件。</p>
<h4 id="生成图片均值文件"><a href="#生成图片均值文件" class="headerlink" title="生成图片均值文件"></a>生成图片均值文件</h4><p>为了提高速度和精度，我们一般还会计算并让图片减去均值，这个用caffe自带的工具函数就能实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo build/tools/compute_image_mean examples/mnist/mnist_train_lmdb examples/mnist/mean.binaryproto</div></pre></td></tr></table></figure>
<p>第一个参数：examples/mnist/mnist_train_lmdb， 表示需要计算均值的数据，格式为lmdb的训练数据。<br>第二个参数：examples/mnist/mean.binaryproto， 计算出来的结果保存文件。</p>
<h2 id="网络层layer介绍"><a href="#网络层layer介绍" class="headerlink" title="网络层layer介绍"></a>网络层layer介绍</h2><p>这个部分我们就简绍卷积神经网络中最主要的两个层卷积(convolution)层和池化(pooling)层。</p>
<h4 id="Convolution层"><a href="#Convolution层" class="headerlink" title="Convolution层"></a>Convolution层</h4><p>就是卷积层，是卷积神经网络（CNN）的核心层。<br>示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">layer &#123;</div><div class="line">  name: &quot;conv1&quot;</div><div class="line">  type: &quot;Convolution&quot;</div><div class="line">  bottom: &quot;data&quot;</div><div class="line">  top: &quot;conv1&quot;</div><div class="line">  param &#123;</div><div class="line">    lr_mult: 1</div><div class="line">  &#125;</div><div class="line">  param &#123;</div><div class="line">    lr_mult: 2</div><div class="line">  &#125;</div><div class="line">  convolution_param &#123;</div><div class="line">    num_output: 20</div><div class="line">    kernel_size: 5</div><div class="line">    stride: 1</div><div class="line">    weight_filler &#123;</div><div class="line">      type: &quot;xavier&quot;</div><div class="line">    &#125;</div><div class="line">    bias_filler &#123;</div><div class="line">      type: &quot;constant&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要参数介绍:  </p>
<ul>
<li><p>num_output: 卷积核（filter)的个数</p>
</li>
<li><p>kernel_size: 卷积核的大小。如果卷积核的长和宽不等，需要用kernel_h和kernel_w分别设定</p>
</li>
</ul>
<p>其它参数：</p>
<ul>
<li><p>stride: 卷积核的步长，默认为1。也可以用stride_h和stride_w来设置。</p>
</li>
<li><p>pad: 扩充边缘，默认为0，不扩充。 扩充的时候是左右、上下对称的，比如卷积核的大小为5*5，那么pad设置为2，则四个边缘都扩充2个像素，即宽度和高度都扩充了4个像素,这样卷积运算之后的特征图就不会变小。也可以通过pad_h和pad_w来分别设定。</p>
</li>
<li><p>weight_filler: 权值初始化。 默认为“constant”,值全为0，很多时候我们用”xavier”算法来进行初始化，也可以设置为”gaussian”</p>
</li>
<li><p>bias_filler: 偏置项的初始化。一般设置为”constant”,值全为0。</p>
</li>
<li><p>bias_term: 是否开启偏置项，默认为true, 开启</p>
</li>
<li><p>group: 分组，默认为1组。如果大于1，我们限制卷积的连接操作在一个子集内。如果我们根据图像的通道来分组，那么第i个输出分组只能与第i个输入分组进行连接。</p>
</li>
</ul>
<h4 id="Pooling层"><a href="#Pooling层" class="headerlink" title="Pooling层"></a>Pooling层</h4><p>也叫池化层，为了减少运算量和数据维度而设置的一种层。<br>示例代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">layer &#123;</div><div class="line">  name: &quot;pool1&quot;</div><div class="line">  type: &quot;Pooling&quot;</div><div class="line">  bottom: &quot;conv1&quot;</div><div class="line">  top: &quot;pool1&quot;</div><div class="line">  pooling_param &#123;</div><div class="line">    pool: MAX</div><div class="line">    kernel_size: 3</div><div class="line">    stride: 2</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要参数介绍：</p>
<ul>
<li>kernel_size: 池化的核大小。也可以用kernel_h和kernel_w分别设定。</li>
</ul>
<p>其它参数：</p>
<ul>
<li><p>pool: 池化方法，默认为MAX。目前可用的方法有MAX, AVE, 或STOCHASTIC</p>
</li>
<li><p>pad: 和卷积层的pad的一样，进行边缘扩充。默认为0</p>
</li>
<li><p>stride: 池化的步长，默认为1。一般我们设置为2，即不重叠。也可以用stride_h和stride_w来设置。</p>
</li>
</ul>
<p>pooling层的运算方法基本是和卷积层是一样的。</p>
<h3 id="我的网络模型"><a href="#我的网络模型" class="headerlink" title="我的网络模型"></a>我的网络模型</h3><p>包括一个数据层，两个卷积层，两个池化层和两个全连接层。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div></pre></td><td class="code"><pre><div class="line">name: &quot;MY_FIRST_quick&quot;</div><div class="line">layer &#123;</div><div class="line">  name: &quot;my_first&quot;</div><div class="line">  type: &quot;Data&quot;</div><div class="line">  top: &quot;data&quot;</div><div class="line">  top: &quot;label&quot;</div><div class="line">  include &#123;</div><div class="line">    phase: TRAIN</div><div class="line">  &#125;</div><div class="line">  transform_param &#123;</div><div class="line">    scale: 0.00390625</div><div class="line">    mean_file: &quot;examples/my_first/mean.binaryproto&quot;</div><div class="line">  &#125;</div><div class="line">  data_param &#123;</div><div class="line">    source: &quot;examples/my_first/train/img_train_lmdb&quot;</div><div class="line">    batch_size: 10</div><div class="line">    backend: LMDB</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">layer &#123;</div><div class="line">  name: &quot;my_first&quot;</div><div class="line">  type: &quot;Data&quot;</div><div class="line">  top: &quot;data&quot;</div><div class="line">  top: &quot;label&quot;</div><div class="line">  include &#123;</div><div class="line">    phase: TEST</div><div class="line">  &#125;</div><div class="line">  transform_param &#123;</div><div class="line">    scale: 0.00390625</div><div class="line">    mean_file: &quot;examples/my_first/mean.binaryproto&quot;</div><div class="line">  &#125;</div><div class="line">  data_param &#123;</div><div class="line">    source: &quot;examples/my_first/test/img_test_lmdb&quot;</div><div class="line">    batch_size: 10</div><div class="line">    backend: LMDB</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">layer &#123;</div><div class="line">  name: &quot;conv1&quot;</div><div class="line">  type: &quot;Convolution&quot;</div><div class="line">  bottom: &quot;data&quot;</div><div class="line">  top: &quot;conv1&quot;</div><div class="line">  param &#123;</div><div class="line">    lr_mult: 1</div><div class="line">  &#125;</div><div class="line">  param &#123;</div><div class="line">    lr_mult: 2</div><div class="line">  &#125;</div><div class="line">  convolution_param &#123;</div><div class="line">    num_output: 55</div><div class="line">    pad: 2</div><div class="line">    kernel_size: 5</div><div class="line">    stride: 1</div><div class="line">    weight_filler &#123;</div><div class="line">      type: &quot;xavier&quot;</div><div class="line">    &#125;</div><div class="line">    bias_filler &#123;</div><div class="line">      type: &quot;constant&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">layer &#123;</div><div class="line">  name: &quot;pool1&quot;</div><div class="line">  type: &quot;Pooling&quot;</div><div class="line">  bottom: &quot;conv1&quot;</div><div class="line">  top: &quot;pool1&quot;</div><div class="line">  pooling_param &#123;</div><div class="line">    pool: MAX</div><div class="line">    kernel_size: 3</div><div class="line">    stride: 2</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">layer &#123;</div><div class="line">  name: &quot;conv2&quot;</div><div class="line">  type: &quot;Convolution&quot;</div><div class="line">  bottom: &quot;pool1&quot;</div><div class="line">  top: &quot;conv2&quot;</div><div class="line">  param &#123;</div><div class="line">    lr_mult: 1</div><div class="line">  &#125;</div><div class="line">  param &#123;</div><div class="line">    lr_mult: 2</div><div class="line">  &#125;</div><div class="line">  convolution_param &#123;</div><div class="line">    num_output: 27</div><div class="line">    kernel_size: 5</div><div class="line">    stride: 1</div><div class="line">    weight_filler &#123;</div><div class="line">      type: &quot;xavier&quot;</div><div class="line">    &#125;</div><div class="line">    bias_filler &#123;</div><div class="line">      type: &quot;constant&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">layer &#123;</div><div class="line">  name: &quot;pool2&quot;</div><div class="line">  type: &quot;Pooling&quot;</div><div class="line">  bottom: &quot;conv2&quot;</div><div class="line">  top: &quot;pool2&quot;</div><div class="line">  pooling_param &#123;</div><div class="line">    pool: AVE</div><div class="line">    kernel_size: 3</div><div class="line">    stride: 2</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">layer &#123;</div><div class="line">  name: &quot;ip1&quot;</div><div class="line">  type: &quot;InnerProduct&quot;</div><div class="line">  bottom: &quot;pool2&quot;</div><div class="line">  top: &quot;ip1&quot;</div><div class="line">  param &#123;</div><div class="line">    lr_mult: 1</div><div class="line">  &#125;</div><div class="line">  param &#123;</div><div class="line">    lr_mult: 2</div><div class="line">  &#125;</div><div class="line">  inner_product_param &#123;</div><div class="line">    num_output: 500</div><div class="line">    weight_filler &#123;</div><div class="line">      type: &quot;xavier&quot;</div><div class="line">    &#125;</div><div class="line">    bias_filler &#123;</div><div class="line">      type: &quot;constant&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">layer &#123;</div><div class="line">  name: &quot;relu1&quot;</div><div class="line">  type: &quot;ReLU&quot;</div><div class="line">  bottom: &quot;ip1&quot;</div><div class="line">  top: &quot;ip1&quot;</div><div class="line">&#125;</div><div class="line">layer &#123;</div><div class="line">  name: &quot;ip2&quot;</div><div class="line">  type: &quot;InnerProduct&quot;</div><div class="line">  bottom: &quot;ip1&quot;</div><div class="line">  top: &quot;ip2&quot;</div><div class="line">  param &#123;</div><div class="line">    lr_mult: 1</div><div class="line">  &#125;</div><div class="line">  param &#123;</div><div class="line">    lr_mult: 2</div><div class="line">  &#125;</div><div class="line">  inner_product_param &#123;</div><div class="line">    num_output: 5</div><div class="line">    weight_filler &#123;</div><div class="line">      type: &quot;xavier&quot;</div><div class="line">    &#125;</div><div class="line">    bias_filler &#123;</div><div class="line">      type: &quot;constant&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">layer &#123;</div><div class="line">  name: &quot;accuracy&quot;</div><div class="line">  type: &quot;Accuracy&quot;</div><div class="line">  bottom: &quot;ip2&quot;</div><div class="line">  bottom: &quot;label&quot;</div><div class="line">  top: &quot;accuracy&quot;</div><div class="line">  include &#123;</div><div class="line">    phase: TEST</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">layer &#123;</div><div class="line">  name: &quot;loss&quot;</div><div class="line">  type: &quot;SoftmaxWithLoss&quot;</div><div class="line">  bottom: &quot;ip2&quot;</div><div class="line">  bottom: &quot;label&quot;</div><div class="line">  top: &quot;loss&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="solver文件介绍"><a href="#solver文件介绍" class="headerlink" title="solver文件介绍"></a>solver文件介绍</h2><p>solver文件可以算是caffe里最核心的文件了，它就相当于是电脑的CPU，控制着整个网络的运行。<br>在每一次的迭代过程中，solver做了这几步工作：</p>
<ul>
<li>1、调用forward算法来计算最终的输出值，以及对应的loss</li>
<li>2、调用backward算法来计算每层的梯度</li>
<li>3、根据选用的slover方法，利用梯度进行参数更新</li>
<li>4、记录并保存每次迭代的学习率、快照，以及对应的状态。</li>
</ul>
<p>以我的solver文件为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># The train/test net protocol buffer definition</div><div class="line">net: &quot;examples/my_first/my_first_quick_train_test.prototxt&quot;</div><div class="line"># test_iter specifies how many forward passes the test should carry out.</div><div class="line">test_iter: 50</div><div class="line"># Carry out testing every 1000 training iterations.</div><div class="line">test_interval: 1000</div><div class="line"># The base learning rate, momentum and the weight decay of the network.</div><div class="line">base_lr: 0.0001</div><div class="line">momentum: 0.9</div><div class="line">weight_decay: 0.004</div><div class="line"># The learning rate policy</div><div class="line">lr_policy: &quot;fixed&quot;</div><div class="line"># Display every 100 iterations</div><div class="line">display: 100</div><div class="line"># The maximum number of iterations</div><div class="line">max_iter: 10000</div><div class="line"># snapshot intermediate results</div><div class="line">#snapshot: 5000</div><div class="line">#snapshot_format: HDF5</div><div class="line">#snapshot_prefix: &quot;examples/my_first/my_first_quick&quot;</div><div class="line"># solver mode: CPU or GPU</div><div class="line">solver_mode: CPU</div></pre></td></tr></table></figure>
<p>lr_policy可以设置为下面这些值，相应的学习率的计算为：</p>
<ul>
<li>fixed:　　 保持base_lr不变.</li>
<li>step: 　　 如果设置为step,则还需要设置一个stepsize, 返回 base_lr * gamma ^ (floor(iter / stepsize)),其中iter表示当前的迭代次数</li>
<li>exp: 　　返回base_lr * gamma ^ iter， iter为当前迭代次数</li>
<li>inv:　　 如果设置为inv,还需要设置一个power, 返回base_lr <em> (1 + gamma </em> iter) ^ (- power)</li>
<li>multistep: 如果设置为multistep,则还需要设置一个stepvalue。这个参数和step很相似，step是均匀等间隔变化，而multistep则是根据 stepvalue值变化</li>
<li>poly: 　　 学习率进行多项式误差, 返回 base_lr (1 - iter/max_iter) ^ (power)</li>
<li>sigmoid:　学习率进行sigmod衰减，返回 base_lr ( 1/(1 + exp(-gamma * (iter - stepsize))))</li>
</ul>
<h2 id="训练及结果"><a href="#训练及结果" class="headerlink" title="训练及结果"></a>训练及结果</h2><p>同样编写sh脚本文件在终端运行程序，可以看到网络模型的运行过程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env sh</div><div class="line">set -e</div><div class="line"></div><div class="line">TOOLS=./build/tools</div><div class="line"></div><div class="line">$TOOLS/caffe train \</div><div class="line">  --solver=examples/my_first/my_first_quick_solver.prototxt $@</div></pre></td></tr></table></figure>
<p>结果如下图所示：<br><img src="/img/result1.jpg" alt="运行结果"></p>
<h2 id="心得体会"><a href="#心得体会" class="headerlink" title="心得体会"></a>心得体会</h2><p>caffe本身是简单易用的，但是若对神经网络本身算法原理一窍不通，就无法设置合适的参数，来提高图片识别的准确度。因此，在熟练使用工具的基础上，还要加强对算法原理的了解掌握，这两者是相辅相成的关系。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="https://github.com/manutdzou/manutdzou.github.io/blob/master/_posts/%E7%A7%91%E7%A0%94/2016-05-15-Caffe-Usage.md" target="_blank" rel="external">https://github.com/manutdzou/manutdzou.github.io/blob/master/_posts/%E7%A7%91%E7%A0%94/2016-05-15-Caffe-Usage.md</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/02/caffe自定义网络模型实现图像识别/" data-id="cixhql1gf0001f6fy72d6gn40" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-caffe实现性别预测" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/02/caffe实现性别预测/" class="article-date">
  <time datetime="2017-01-02T12:28:09.000Z" itemprop="datePublished">2017-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/02/caffe实现性别预测/">caffe实现性别预测</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在<a href="https://bearvic.github.io/2017/01/02/caffe%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB/" target="_blank" rel="external">自定义网络模型实现图像识别</a>中介绍了caffe的基本用法，关于caffe的介绍在此不再赘述。<br>介绍这篇文章之前首先特别感谢<a href="http://www.github.summer007.com/2016/12/25/np2016/" target="_blank" rel="external">夏天大神</a>的指导交流。这篇文章中使用了caffe的python接口，数据为数组元素而非图像，依然有参考价值。  </p>
<h3 id="数据输入"><a href="#数据输入" class="headerlink" title="数据输入"></a>数据输入</h3><p>数据如下显示：<br><img src="/img/data_sex.jpg" alt="性别预测数据">  </p>
<p>数据转换代码如下所示    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"># -*- coding: utf-8 -*-</div><div class="line">import numpy as np</div><div class="line">import random</div><div class="line">import subprocess</div><div class="line">import platform</div><div class="line">import sys,os</div><div class="line">sys.path.append(&apos;/home/hero/caffe/python&apos;)</div><div class="line">import caffe</div><div class="line">import lmdb</div><div class="line">from sklearn.cross_validation import StratifiedShuffleSplit</div><div class="line">import pandas as pd</div><div class="line">import numpy as np</div><div class="line">import matplotlib.pyplot as plt</div><div class="line">import math</div><div class="line"></div><div class="line"></div><div class="line">matrix = np.loadtxt(&apos;train.csv&apos;, dtype=&apos;string&apos;, skiprows= 1,delimiter=&apos;,&apos;, usecols=(1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28))</div><div class="line">matrix = np.asarray(matrix)</div><div class="line">features = matrix[:,1:27]</div><div class="line">labels  = matrix[:,0]</div><div class="line">features = features.astype(np.float) #convert string to float</div><div class="line">#将性别转成int</div><div class="line">for i in range(len(labels)):</div><div class="line">    if labels[i] == &apos;\xc4\xd0&apos;:</div><div class="line">        labels[i] = 1</div><div class="line">    else :</div><div class="line">        if labels[i] != &apos;1&apos;:</div><div class="line">            labels[i] = 0</div><div class="line">#向量化操作</div><div class="line">vec_log = np.vectorize(lambda x: math.log(x+1))</div><div class="line">vec_int = np.vectorize(lambda str: int(str[-1]))</div><div class="line"></div><div class="line">features = vec_log(features)</div><div class="line">labels = vec_int(labels)</div><div class="line"></div><div class="line">#这里将数据分割成训练数据和测试数据</div><div class="line">sss = StratifiedShuffleSplit(labels, 1, test_size=0.02, random_state=0)</div><div class="line">sss = list(sss)[0]</div><div class="line"></div><div class="line">features_training = features[sss[0],]</div><div class="line">labels_training = labels[sss[0],]</div><div class="line"></div><div class="line">features_testing = features[sss[1],]</div><div class="line">labels_testing = labels[sss[1],]</div><div class="line"></div><div class="line">#这个函数中将数据转成lmdb格式</div><div class="line">def load_data_into_lmdb(lmdb_name, features, labels=None):</div><div class="line">    env = lmdb.open(lmdb_name, map_size=features.nbytes*10)</div><div class="line">    features = features[:,:,None,None]</div><div class="line">    for i in range(features.shape[0]):</div><div class="line">        datum = caffe.proto.caffe_pb2.Datum()</div><div class="line">        datum.channels = features.shape[1]   # features&apos;s number(26)</div><div class="line">        datum.height = 1                     # due to eachone only have one data</div><div class="line">        datum.width = 1                      # so the size is 1x1</div><div class="line">        if features.dtype == np.int:         # convert data to string</div><div class="line">            datum.data = features[i].tostring()</div><div class="line">        elif features.dtype == np.float:</div><div class="line">            datum.float_data.extend(features[i].flat)</div><div class="line">        else:</div><div class="line">            raise Exception(&quot;features.dtype unknown.&quot;)</div><div class="line">        if labels is not None:</div><div class="line">            datum.label = int(labels[i])</div><div class="line">        str_id = &apos;&#123;:08&#125;&apos;.format(i)</div><div class="line">        with env.begin(write=True) as txn:</div><div class="line">            txn.put(str_id, datum.SerializeToString())</div><div class="line">#这个函数用于获取数据进行预测</div><div class="line">def get_data_from_lmdb_evalue(lmdb_name):</div><div class="line">    lmdb_env = lmdb.open(lmdb_name, readonly=True)</div><div class="line">    lmdb_txn = lmdb_env.begin()</div><div class="line">    lmdb_cursor = lmdb_txn.cursor()</div><div class="line">    datum = caffe.proto.caffe_pb2.Datum()</div><div class="line">    success = 0</div><div class="line">    count = 0</div><div class="line">    #raw_datum = lmdb_txn.get()</div><div class="line">    for key, value in lmdb_cursor:</div><div class="line">        datum.ParseFromString(value)</div><div class="line">        label = datum.label</div><div class="line">        feature = caffe.io.datum_to_array(datum)</div><div class="line">        out = net.forward(**&#123;net.inputs[0]: np.asarray([feature])&#125;)</div><div class="line">        count+=1</div><div class="line">        if np.argmax(out[&quot;prob&quot;][0]) == label :</div><div class="line">            success+=1</div><div class="line">            print &quot;success&quot;, out</div><div class="line">    return count,success</div><div class="line"></div><div class="line"></div><div class="line">load_data_into_lmdb(&quot;train_data_lmdb&quot;, features_training, labels_training)</div><div class="line">load_data_into_lmdb(&quot;test_data_lmdb&quot;, features_testing, labels_testing)</div></pre></td></tr></table></figure>
<p>关于以上代码的几点说明：  </p>
<ul>
<li>使用numpy工具以矩阵形式读入csv数据文件，因为性别为string类型，需要将其转换成int类型；</li>
<li>为了提高准确度，夏天大神写了一个nomalize函数对数据进行了归一化处理，而我就在对数据向量化处理时对数据做log运算操作<br><code>vec_log = np.vectorize(lambda x: math.log(x+1))</code></li>
<li>其他细节可以看上面代码注释，整体来说还是通俗易懂的。</li>
</ul>
<h3 id="训练及预测"><a href="#训练及预测" class="headerlink" title="训练及预测"></a>训练及预测</h3><p>训练和预测的python代码很简单，如下所示：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#根据配置文件开始训练模型</div><div class="line">solver = caffe.get_solver(&quot;train.prototxt&quot;)</div><div class="line">solver.solve()</div><div class="line"></div><div class="line">net = caffe.Net(&quot;model_prod.prototxt&quot;,&quot;_iter_500000.caffemodel&quot;, caffe.TEST)</div><div class="line"></div><div class="line">total,success = get_data_from_lmdb_evalue(&quot;test_data_lmdb/&quot;)</div><div class="line">print &quot;accuracy:&quot;, success*100/total,&quot;%&quot;</div></pre></td></tr></table></figure>
<p>网络模型定义了两个全连接层，relu激发函数，学习率变化策略使用了inv，数据较少，迭代次数都调到上万。训练时准确度到过80+，实际预测准确度最终达到71%。<br>结果如下所示：<br><img src="/img/sex_predic_res1.jpg" alt="训练结果"><br><img src="/img/sex_predic_res1.jpg" alt="预测结果">  </p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="http://nbviewer.jupyter.org/github/joyofdata/joyofdata-articles/blob/master/deeplearning-with-caffe/Neural-Networks-with-Caffe-on-the-GPU.ipynb" target="_blank" rel="external">http://nbviewer.jupyter.org/github/joyofdata/joyofdata-articles/blob/master/deeplearning-with-caffe/Neural-Networks-with-Caffe-on-the-GPU.ipynb</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/02/caffe实现性别预测/" data-id="cixhql1g60000f6fyh3dmnnl2" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-网络程序设计总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/02/网络程序设计总结/" class="article-date">
  <time datetime="2017-01-02T12:13:39.000Z" itemprop="datePublished">2017-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/02/网络程序设计总结/">网络程序设计总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>当初抱着对时下热门的机器学习、神经网络等知识的好奇心，选了孟宁老师的网络程序设计。<br>老实说，对一个自学能力极差又零基础的人而言，孟宁老师的授课方式一开始真没适应过来。学得慢，代码写的慢，好不容易有点微小的成果，没来得及pull request，别人就已经上传了，写的还比我的好。导致的后果就是所谓的课程零贡献，不知道会不会挂科。<br>但是上课的意义就是为了让学生学到东西，通过这门课，我学到了很多，包括对机器学习、神经网络的认识很理解，以及对一些机器学习基本框架的使用，包括caffe、tensorflow、keras。</p>
<h2 id="课程目标"><a href="#课程目标" class="headerlink" title="课程目标"></a>课程目标</h2><p>通过实现一个医学辅助诊断的专家系统原型。具体为实现对血常规检测报告OCR识别结果，预测患者的年龄和性别，学习机器学习的常见算法框架，重点分析神经网路，理解和掌握常用算法框架工具的使用。</p>
<h2 id="神经网络介绍"><a href="#神经网络介绍" class="headerlink" title="神经网络介绍"></a>神经网络介绍</h2><p><strong>人工神经网络</strong>（Artificial Neural Networks，简写为ANNs）也简称为神经网络（NNs）或称作连接模型（Connection Model），它是一种模仿动物神经网络行为特征，进行分布式并行信息处理的算法数学模型。这种网络依靠系统的复杂程度，通过调整内部大量节点之间相互连接的关系，从而达到处理信息的目的。<br><strong>人工神经网络</strong>：是一种应用类似于大脑神经突触联接的结构进行信息处理的数学模型。在工程与学术界也常直接简称为“神经网络”或类神经网络。<br>这是百度百科上对<a href="http://baike.baidu.com/link?url=r_O_Nntz8sbG4-PyjU-res4SzpwUBvUzHcPFU-eIkTY-rbxw3ptj_ZW7XYUb1ytB9C1_Co30gxVjRQuGXPIAj97IJ6iu4mbJ0FqmipZ6E2qpO-9VBLyJrOp-_cJedL__" target="_blank" rel="external">神经网络</a>的定义。机器学习是个很神奇的东西，而神经网络就是其中的典型代表。在我看来，一个人对事物的认知不可能将每个事物都高清无码地存储在记忆中。类似于图像JPEG压缩存储中，只存储人类敏感部分的色素一样，人们对一个事物的认识是通过学习它的特征，通过事物之间的特征联系，来识别不同的事物。<br>在机器学习中，我们会定义很多权值参数，我们用计算机学习的过程，就是确定每个权值参数的值，以更好地让计算机能通过这些权值来判断出不同的事物，进而进行不能的选择操作。<br><img src="/img/pic1.jpg" alt="卷积神经网络"><br>如图所示，作为一个工程实践人员，我们要做的就是定义好最适合的神经网络以供机器学习的训练测试，并提供给定格式的数据输入，接收数据输出。<br>在这篇文章里，我会介绍机器学习框架caffe、tensorflow、keras和sklearn的大致用法。然后再介绍课程所做的对血常规检验报告的OCR识别、深度学习与分析。</p>
<h2 id="我的工作（项目贡献）"><a href="#我的工作（项目贡献）" class="headerlink" title="我的工作（项目贡献）"></a>我的工作（项目贡献）</h2><p>本来应该是项目贡献的模块。虽然既没有pull request，也没有分享过PPT。但我自己还是自学了很多内容，因此改为我的工作模块。<br>除了学习课程中的OCR图像识别相关内容，我也很认真地学习了caffe,tensorflow,keras等时下比较热门的机器学习框架，并做了一些相关的项目。我对这门课程付出的努力主要就体现在这些项目上了。内容比较多，我将所要介绍的框架写在了不同的博文上，以下提供链接。  </p>
<blockquote>
<p><a href="https://bearvic.github.io/2017/01/02/install-caffe/" target="_blank" rel="external">caffe安装</a><br><a href="https://bearvic.github.io/2017/01/02/caffe%E5%AE%9E%E7%8E%B0%E6%80%A7%E5%88%AB%E9%A2%84%E6%B5%8B/" target="_blank" rel="external">caffe性别预测</a><br><a href="https://bearvic.github.io/2017/01/02/caffe%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB/" target="_blank" rel="external">caffe自定义网络模型图像识别</a><br><a href="https://bearvic.github.io/2017/01/02/tensorflow%E5%AE%9E%E7%8E%B0%E6%89%8B%E5%86%99%E8%AF%86%E5%88%AB/" target="_blank" rel="external">tensorflow实现简单手写识别</a><br><a href="https://bearvic.github.io/2017/01/03/keras%E5%AE%9E%E7%8E%B0%E6%80%A7%E5%88%AB%E9%A2%84%E6%B5%8B/" target="_blank" rel="external">keras实现性别预测</a>  </p>
</blockquote>
<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p><a href="https://coding.net/u/BearVic/p/np2016/git/tree/master/" target="_blank" rel="external">coding.net</a></p>
<h2 id="对血常规检验报告的OCR识别、深度学习与分析"><a href="#对血常规检验报告的OCR识别、深度学习与分析" class="headerlink" title="对血常规检验报告的OCR识别、深度学习与分析"></a>对血常规检验报告的OCR识别、深度学习与分析</h2><h3 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h3><p><strong>操作系统：</strong>Ubuntu 16.04 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># 安装numpy,</div><div class="line">sudo apt-get install python-numpy # http://www.numpy.org/</div><div class="line"># 安装opencv</div><div class="line">sudo apt-get install python-opencv # http://opencv.org/</div><div class="line"></div><div class="line">#安装OCR和预处理相关依赖</div><div class="line">sudo apt-get install tesseract-ocr</div><div class="line">sudo pip install pytesseract</div><div class="line">sudo apt-get install python-tk</div><div class="line">sudo pip install pillow</div><div class="line"></div><div class="line"># 安装Flask框架、mongo</div><div class="line">sudo pip install Flask</div><div class="line">sudo apt-get install mongodb # 如果找不到可以先sudo apt-get update</div><div class="line">sudo service mongodb started</div><div class="line">sudo pip install pymongo</div><div class="line"></div><div class="line">#安装tensorflow,keras框架</div><div class="line">sudo pip install tensorflow</div><div class="line">sudo pip install keras</div></pre></td></tr></table></figure>
<h4 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd  BloodTestReportOCR</div><div class="line">python view.py # upload图像,在浏览器打开http://yourip:8080</div></pre></td></tr></table></figure>
<h3 id="文件介绍"><a href="#文件介绍" class="headerlink" title="文件介绍"></a>文件介绍</h3><h4 id="view-py"><a href="#view-py" class="headerlink" title="view.py"></a>view.py</h4><p>Web 端上传图片到服务器，存入mongodb并获取oid，稍作修整，希望能往REST架构设计，目前还不完善； 前端采用了vue.js, mvvm模式。写了两个版本，一个是index.html无插件，另一个使用了bootstrap-fileinput插件，有点问题；</p>
<h4 id="imageFilter-py"><a href="#imageFilter-py" class="headerlink" title="imageFilter.py"></a>imageFilter.py</h4><p>对图像透视裁剪和OCR进行了简单的封装，以便于模块间的交互，规定适当的接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">imageFilter = ImageFilter() # 可以传入一个opencv格式打开的图片</div><div class="line">num = 22</div><div class="line">print imageFilter.ocr(num)</div></pre></td></tr></table></figure>
<h4 id="ocr函数-模块主函数返回识别数据"><a href="#ocr函数-模块主函数返回识别数据" class="headerlink" title="ocr函数 - 模块主函数返回识别数据"></a>ocr函数 - 模块主函数返回识别数据</h4><p>用于对img进行ocr识别，他会先进行剪切，之后进一步做ocr识别，返回一个json对象 如果剪切失败，则返回None @num 规定剪切项目数</p>
<h4 id="perspect函数做-初步的矫正图片"><a href="#perspect函数做-初步的矫正图片" class="headerlink" title="perspect函数做 - 初步的矫正图片"></a>perspect函数做 - 初步的矫正图片</h4><p>用于透视image，他会缓存一个透视后的opencv numpy矩阵，并返回该矩阵 透视失败，则会返回None，并打印不是报告 @param 透视参数</p>
<ul>
<li>关于param:  参数的形式为[p1, p2, p3 ,p4 ,p5]。 p1,p2,p3,p4,p5都是整型，其中p1必须是奇数。</li>
</ul>
<p>p1是高斯模糊的参数，p2和p3是canny边缘检测的高低阈值，p4和p5是和筛选有关的乘数。</p>
<p>如果化验报告单放在桌子上时，有的边缘会稍微翘起，产生比较明显的阴影，这种阴影有可能被识别出来，导致定位失败。 解决的方法是调整p2和p3，来将阴影线筛选掉。但是如果将p2和p3调的比较高，就会导致其他图里的黑线也被筛选掉了。 参数的选择是一个问题。 我在getinfo.default中设置的是一个较低的阈值，p2=70,p3=30，这个阈值不会屏蔽阴影线。 如果改为p2=70,p3=50则可以屏蔽，但是会导致其他图片识别困难。</p>
<p>就现在来看，得到较好结果的前提主要有三个</p>
<ul>
<li>化验单尽量平整</li>
<li>图片中应该包含全部的三条黑线</li>
<li>图片尽量不要包含化验单的边缘，如果有的话，请尽量避开有阴影的边缘。</li>
</ul>
<h4 id="filter函数-过滤掉不合格的或非报告图片"><a href="#filter函数-过滤掉不合格的或非报告图片" class="headerlink" title="filter函数 - 过滤掉不合格的或非报告图片"></a>filter函数 - 过滤掉不合格的或非报告图片</h4><p>返回img经过透视过后的PIL格式的Image对象，如果缓存中有PerspectivImg则直接使用，没有先进行透视 过滤失败则返回None @param filter参数</p>
<h4 id="autocut函数-将图片中性别、年龄、日期和各项目名称数据分别剪切出来"><a href="#autocut函数-将图片中性别、年龄、日期和各项目名称数据分别剪切出来" class="headerlink" title="autocut函数 - 将图片中性别、年龄、日期和各项目名称数据分别剪切出来"></a>autocut函数 - 将图片中性别、年龄、日期和各项目名称数据分别剪切出来</h4><p>用于剪切ImageFilter中的img成员，剪切之后临时图片保存在out_path， 如果剪切失败，返回-1，成功返回0 @num 剪切项目数 @param 剪切参数</p>
<p>剪切出来的图片在BloodTestReportOCR/temp_pics/ 文件夹下</p>
<p>函数输出为data0.jpg,data1.jpg……等一系列图片，分别是白细胞计数，中性粒细胞记数等的数值的图片。</p>
<h4 id="classifier-py"><a href="#classifier-py" class="headerlink" title="classifier.py"></a>classifier.py</h4><p>用于判定裁剪矫正后的报告和裁剪出检测项目的编号</p>
<h4 id="imgproc-py"><a href="#imgproc-py" class="headerlink" title="imgproc.py"></a>imgproc.py</h4><p>将识别的图像进行处理二值化等操作，提高识别率 包括对中文和数字的处理</p>
<h4 id="digits"><a href="#digits" class="headerlink" title="digits"></a>digits</h4><p>将该文件替换Tesseract-OCR\tessdata\configs中的digits</p>
<h3 id="主要知识介绍"><a href="#主要知识介绍" class="headerlink" title="主要知识介绍"></a>主要知识介绍</h3><h4 id="图像处理-透视变换"><a href="#图像处理-透视变换" class="headerlink" title="图像处理 - 透视变换"></a>图像处理 - 透视变换</h4><ul>
<li>图像预处理去噪<br><img src="/img/toushibianhuan1.jpg" alt="降噪后的图片"></li>
<li>采用Canny算子提取边缘<br><img src="/img/toushibianhuan2.jpg" alt="提取边缘后的图片"></li>
<li>画线使用变换公式生成图片<br><img src="/img/toushibianhuan3.jpg" alt="透视变化后的图片"></li>
</ul>
<h4 id="ocr图像识别"><a href="#ocr图像识别" class="headerlink" title="ocr图像识别"></a>ocr图像识别</h4><p>提高图像识别的方法：  </p>
<ul>
<li>对图片进行二值化处理，这里我使用了ostu算法对图像进行二值化处理，它是一种高效的二值化算法，可以参考wiki里关于算法的详细介绍。</li>
<li>为了处理图片中的噪声点，对图片进行了腐蚀操作</li>
<li>将图片放大，Tesseract对于较大的图片有较好的识别结果</li>
<li>再次腐蚀被放大的噪声点</li>
<li>膨胀使图片内容饱满便于识别</li>
<li>直方图均衡化，提高图片的对比度</li>
<li>中值滤波去除孤立的噪声点 </li>
</ul>
<p>切割后的数据：<br><img src="/img/qiegehoutupian.jpg" alt="切割后的图片">  </p>
<p>识别成的最终数据：<br><img src="/img/shujushibie.jpg" alt="最终识别显示的数据">  </p>
<h4 id="使用机器学习框架进行性别预测"><a href="#使用机器学习框架进行性别预测" class="headerlink" title="使用机器学习框架进行性别预测"></a>使用机器学习框架进行性别预测</h4><p><a href="https://bearvic.github.io/2017/01/03/keras%E5%AE%9E%E7%8E%B0%E6%80%A7%E5%88%AB%E9%A2%84%E6%B5%8B/" target="_blank" rel="external">keras方法</a><br><a href="https://bearvic.github.io/2017/01/02/caffe%E5%AE%9E%E7%8E%B0%E6%80%A7%E5%88%AB%E9%A2%84%E6%B5%8B/" target="_blank" rel="external">caffe方法</a></p>
<h3 id="成果展示"><a href="#成果展示" class="headerlink" title="成果展示"></a>成果展示</h3><p>最终预测结果如下：<br><img src="/img/zuihoujieguo.jpg" alt="最终预测结果"></p>
<h2 id="个人心得"><a href="#个人心得" class="headerlink" title="个人心得"></a>个人心得</h2><p><strong>知识方面</strong><br>对机器学习及神经网络有了入门到深入认识的过程。通过提取数据的特征，使用算法表征这些特征并通过特征做出判断识别，这就是一个机器学习的过程。<br>老实说，刚接触人工智能的时候，感觉这些很神奇。也许不就的将来，这会成为科幻电影中智能机器人的开端吧。从简单的二分类数据识别，到最后复杂的行为判断，想想都会觉得兴奋。<br>但是对于神经网络，机器学习，自己真正掌握的还只是九牛一毛。作为一个工程人员，我应该尽可能地去理解相关算法的原理，在理解原理的基础上，使用相关框架工具为不同的任务去搭建最适合的网络，输入合适的数据源，以此来获得良好的结果，通过这些返回的结果，进一步去判断，去选择，让机器显得智能，直到最后真的智能。<br>对于这一方面的发展，我觉得就是要不断精进训练数据，合理搭配最适合的网络。朝着这两个方向不断发展。</p>
<p><strong>课程方面</strong><br>老实说，这门课程的学习还受到很多同学帮助交流，这里特别感谢欧小铉同学、夏天同学和寇亚飞大神的指导和交流，让我在对框架学习的时候不至于陷入死胡同而无法自拔。同时也要感谢孟宁老师对同学们的督促和交流学习。孟宁老师特别的学习方式，然后明白团队协作的重要性。但是由于本人性格内向，自学能力弱外加代码写的慢，正想pr的时候就发现已经有别的同学甚至做的更好的项目已经pr上去了，导致最后零贡献。这些正是我缺乏的吧。在以后的学习中我会争取慢慢改善这些缺点。但最后我还是学到了很多知识，掌握了一定的技能，在此，我再次感谢老师同学们。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/02/网络程序设计总结/" data-id="cixhql1gw0008f6fy29xu61gq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-install-caffe" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/02/install-caffe/" class="article-date">
  <time datetime="2017-01-02T11:56:59.000Z" itemprop="datePublished">2017-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/02/install-caffe/">install caffe</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这本课程中本人自学了caffe框架的用法。caffe是个很好的工具，特别是针对图像处理相关的卷积神经网络。但是本人的电脑系统为macOS，在参照官方文档时候出现问题并得不到解决，似乎是因为系统版本的缘故。后来就索性安装了一个ubuntu的虚拟机，分配了4G内存，两个core。跑官方mnist的例子需要13分钟左右。<br>caffe在ubuntu系统下的安装比较简单，因为显卡问题我没有装GPU，安装基本参照下面的链接网址。安装时候请注意最好换个源下载，因为官方的源速度实在太慢了。装了大半天基本都是在等待下载。<a href="http://hmybmny.com/2016/09/change-sources/" target="_blank" rel="external">换源方法</a></p>
<h2 id="Install-with-CPU"><a href="#Install-with-CPU" class="headerlink" title="Install with CPU"></a>Install with CPU</h2><h3 id="安装依赖库"><a href="#安装依赖库" class="headerlink" title="安装依赖库"></a>安装依赖库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sudo apt update</div><div class="line">sudo apt upgrade</div><div class="line">sudo apt install -y build-essential cmake git pkg-config</div><div class="line">sudo apt install -y libprotobuf-dev libleveldb-dev libsnappy-dev \</div><div class="line">                    libopencv-dev libhdf5-serial-dev protobuf-compiler</div><div class="line">sudo apt install -y --no-install-recommends libboost-all-dev</div></pre></td></tr></table></figure>
<blockquote>
<p>如果使用 OpenBlas 代替默认的 ATLAS的话，需要将 libatlas-base-dev 改为 libopenblas-dev</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo apt install -y libatlas-base-dev </div><div class="line">sudo apt install -y libgflags-dev libgoogle-glog-dev liblmdb-dev</div><div class="line">sudo apt install -y python-pip python-dev python-numpy python-scipy</div></pre></td></tr></table></figure>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cd ~/</div><div class="line">git clone https://github.com/BVLC/caffe.git</div><div class="line">cd caffe/</div><div class="line">cp Makefile.config.example Makefile.config</div><div class="line">vim Makefile.config</div></pre></td></tr></table></figure>
<ul>
<li>取消注释  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">CPU_ONLY := 1    </div><div class="line">WITH\_PYTHON\_LAYER := 1</div></pre></td></tr></table></figure>
<ul>
<li>如果选择 CPU 安装的话，最好使用 OpenBlas 代替默认的 ATLAS，因为 OpenBlas 对 CPU 多线程支持很好，能加快一点速度算一点吧。修改<br><code>BLAS := open</code></li>
<li>并运行以下命令（使用 OpenBlas 的情况下）<br><code>echo &#39;export OPENBLAS_NUM_THREADS=4&#39; &gt;&gt; ~/.bashrc</code></li>
<li>修改  </li>
</ul>
<p><code>INCLUDE_DIRS := $(PYTHON_INCLUDE)  /usr/local/include /usr/include/hdf5/serial</code><br><code>LIBRARY_DIRS := $(PYTHON_LIB)  /usr/local/lib /usr/lib /usr/lib/x86_64-linux-gnu /usr/lib/x86_64-linux-gnu/hdf5/serial</code></p>
<h3 id="安装-make-pycaffe-所需的库"><a href="#安装-make-pycaffe-所需的库" class="headerlink" title="安装 make pycaffe 所需的库"></a>安装 make pycaffe 所需的库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd python</div><div class="line">sudo -H pip2 install -r requirements.txt</div></pre></td></tr></table></figure>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cd ..</div><div class="line">make all -j $(($(nproc) + 1))</div><div class="line">make test</div><div class="line">make runtest</div><div class="line">make pycaffe</div><div class="line">make distribute</div><div class="line"></div><div class="line">#user 是你的用户名</div><div class="line">echo &apos;export PYTHONPATH=/home/user/caffe/python:$PYTHONPATH&apos; &gt;&gt; ~/.bashrc</div></pre></td></tr></table></figure>
<h3 id="重启终端"><a href="#重启终端" class="headerlink" title="重启终端"></a>重启终端</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">python</div><div class="line">&gt;&gt;&gt;import caffe </div><div class="line">&gt;&gt;&gt;               # 没报错就成功了</div></pre></td></tr></table></figure>
<p>至此，caffe就算安装完成了，接下来就愉快的开始使用caffe吧。</p>
<h3 id="参考网址"><a href="#参考网址" class="headerlink" title="参考网址"></a>参考网址</h3><p><a href="http://hmybmny.com/2016/10/install-caffe-on-ubuntu-16-dot-04-with-gpu/" target="_blank" rel="external">http://hmybmny.com/2016/10/install-caffe-on-ubuntu-16-dot-04-with-gpu/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/02/install-caffe/" data-id="cixhql1gj0003f6fykqisv85n" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-new-one" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/30/new-one/" class="article-date">
  <time datetime="2016-12-30T01:35:02.000Z" itemprop="datePublished">2016-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/30/new-one/">new one</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="感悟总结"><a href="#感悟总结" class="headerlink" title="感悟总结"></a>感悟总结</h1><p>普通大小的字体 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/30/new-one/" data-id="cixhql1gr0006f6fyef5eyztz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-new-article" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/30/new-article/" class="article-date">
  <time datetime="2016-12-30T01:29:08.000Z" itemprop="datePublished">2016-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/30/new-article/">new article</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#感悟总结</p>
<p>##第一个篇章</p>
<p>###第一节</p>
<p>####第一小节</p>
<p>#####第一小节的第一段<br>普通大小的字体 </p>
<p><strong>加粗</strong></p>
<p><em>斜体</em></p>
<p>“没事”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this is the code zone!</div></pre></td></tr></table></figure>
<p><em>ab</em></p>
<h1 id="a"><a href="#a" class="headerlink" title="a"></a>a</h1><p>what’s this?<br><img src="/img/1.jpg" alt="Alt Image Text"></p>
<h2 id="b"><a href="#b" class="headerlink" title="b"></a>b</h2><p>let’s try url:<a href="http://www.baidu.com" target="_blank" rel="external">baidu</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/30/new-article/" data-id="cixhql1gp0005f6fywkl8kuln" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/29/hello-world/" class="article-date">
  <time datetime="2016-12-29T12:45:11.000Z" itemprop="datePublished">2016-12-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/29/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/29/hello-world/" data-id="cixhql1gi0002f6fyvykeldob" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/01/03/keras实现性别预测/">keras实现性别预测</a>
          </li>
        
          <li>
            <a href="/2017/01/02/tensorflow实现手写识别/">tensorflow实现手写识别</a>
          </li>
        
          <li>
            <a href="/2017/01/02/caffe自定义网络模型实现图像识别/">caffe自定义网络模型实现图像识别</a>
          </li>
        
          <li>
            <a href="/2017/01/02/caffe实现性别预测/">caffe实现性别预测</a>
          </li>
        
          <li>
            <a href="/2017/01/02/网络程序设计总结/">网络程序设计总结</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 BearVic<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>